{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Update Debit</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
.hidden { display:none; }
#emi-section { background:#f8f9fa; padding:15px; border-radius:8px; margin-top:15px; }
</style>
</head>
<body>

<div class="container mt-4">
    <div class="col-md-8 mx-auto">
        {% if popup_message %}
        <script>
            alert("{{ popup_message }}");
        </script>
        {% endif %}

        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4>Update Debit</h4>
            </div>

            <div class="card-body">
                <form method="POST">
                    {% csrf_token %}

                    <!-- Basic Fields -->
                    <div class="mb-3">
                        <label>Lender Name</label>
                        <input type="text" class="form-control" name="lender_name" value="{{ debit.lender_name }}" required>
                    </div>

                    <div class="mb-3">
                        <label>Principal Amount</label>
                        <input type="number" step="0.01" class="form-control" name="principal_amount" value="{{ debit.amount }}" required>
                    </div>

                    <div class="mb-3">
                        <label>Start Date</label>
                        <input type="date"
                        class="form-control"
                        name="start_date"
                        value="{{ debit.start_date|date:'Y-m-d' }}"
                        required>
                                     </div>

                    <div class="mb-3">
                        <label>Notes</label>
                        <textarea class="form-control" name="notes" rows="3">{{ debit.notes }}</textarea>
                    </div>

                    <!-- EMI Checkbox -->
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="id_is_emi" name="is_emi" {% if debit.is_emi %}checked{% endif %}>
                        <label class="form-check-label" for="id_is_emi">Is EMI?</label>
                    </div>

                    <!-- EMI Section -->
                    <div id="emi-section" class="hidden">
                        <h5 class="text-primary fw-bold">EMI Details</h5>

                      <!-- EMI Type -->
<div class="mb-3">
    <label>EMI Type</label>
    <select class="form-select" id="emi_type" name="emi_type">
        <option value="">Select EMI Type</option>
        {% for val,label in emi_types %}
            {% if val != "NO" %}
            <option value="{{ val }}" {% if debit.emi_type == val %}selected{% endif %}>{{ label }}</option>
            {% endif %}
        {% endfor %}
    </select>
</div>

<!-- Installment Frequency -->
<div class="mb-3">
    <label>Installment Frequency</label>
    <select class="form-select" name="installment_frequency">
        <option value="">Select Frequency</option>
        {% for val,label in installment_types %}
            <option value="{{ val }}" {% if debit.installment_type == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
    </select>
</div>


                        <!-- Number of Installments -->
                        <div class="mb-3">
                            <label>Number of Installments</label>
                            <input type="number" class="form-control" name="installments" value="{{ debit.emi_period }}">
                        </div>

                        <!-- Interest Rate -->
                        <div id="interest-field" class="mb-3">
                            <label>EMI Interest Rate (%)</label>
                            <input type="number" step="0.01" class="form-control" name="emi_interest_rate" value="{{ debit.interest_percent }}">
                        </div>

                        <!-- Custom EMI -->
                        <div id="custom-emi-field" class="mb-3 hidden">
                            <label>Custom EMI Amount</label>
                            <input type="number" step="0.01" class="form-control" name="emi_amt" value="{{ debit.emi_amount }}">
                        </div>

                        <!-- Display existing EMI info if partially paid -->
                        {% if existing_emis %}
                        <div class="mt-3">
                            <h6>Existing EMIs:</h6>
                            <ul class="list-group">
                                {% for emi in existing_emis %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Seq {{ emi.sequence_number }}: Amount {{ emi.amount }}
                                    {% if emi.status == "PAID" %}
                                    <span class="badge bg-success">Paid on {{ emi.paid_date }}</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">Pending</span>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <a href="{% url 'view_all' %}" class="btn btn-secondary w-50">
                            ‚Üê Back to All Debits
                        </a>
                        <button type="submit" class="btn btn-success w-50">
                            Update
                        </button>
                    </div>
                                    </form>
            </div>
        </div>
    </div>
</div>

<script>
const isEmi = document.getElementById("id_is_emi");
const emiSection = document.getElementById("emi-section");
const emiType = document.getElementById("emi_type");
const interestField = document.getElementById("interest-field");
const customField = document.getElementById("custom-emi-field");

function toggleEmi() {
    emiSection.classList.toggle("hidden", !isEmi.checked);
}

function toggleType() {
    if (emiType.value === "CUSTOM") {
        interestField.classList.add("hidden");
        customField.classList.remove("hidden");
    } else {
        interestField.classList.remove("hidden");
        customField.classList.add("hidden");
    }
}

isEmi.addEventListener("change", toggleEmi);
emiType.addEventListener("change", toggleType);

// Initialize on page load
toggleEmi();
toggleType();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
